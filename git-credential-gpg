#!/bin/env bash
set -euo pipefail

STORE="$HOME/.git-credentials.gpg"
RECIPIENT=$(gpg --list-secret-keys --with-colons | awk -F: '/^sec/ {print $5; exit}')

case "$1" in
  get)
    if [[ -f "$STORE" ]]; then
      gpg --quiet --decrypt --pinentry-mode loopback "$STORE"
    fi
    ;;
  store)
    tmp=$(mktemp)
    cat >> "$tmp"
    gpg --yes --batch --encrypt -r "$RECIPIENT" "$tmp"
    mv "$tmp.gpg" "$STORE"
    ;;
  erase)
    rm -f "$STORE"
    ;;
esac